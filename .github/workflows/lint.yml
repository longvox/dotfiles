# Lint on push/PR: shellcheck for bash scripts
name: Lint

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Install ShellCheck
        run: sudo apt-get update -qq && sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          set -e
          failed=0
          # Exclude dot/ (submodules), .git, install/utils (third-party), install/lang (sourced from index)
          # -e SC1091: sourced files use runtime paths, shellcheck can't resolve
          # -e SC1090: variable in source (e.g. LANG_INDEX)
          # -e SC2148: lib/*.sh are sourced, not executed (no shebang)
          # -e SC2015: A && B || C is intentional (fallback pattern)
          while IFS= read -r -d '' f; do
            echo "::group::$f"
            if ! shellcheck -e SC1091,SC1090,SC2148,SC2015 -x "$f"; then failed=1; fi
            echo "::endgroup"
          done < <(find . -type f -name '*.sh' ! -path './dot/*' ! -path './.git/*' ! -path './install/utils/*' ! -path './install/lang/*' -print0)
          [[ $failed -eq 0 ]]
